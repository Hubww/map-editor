(function(t){function n(n){for(var i,r,s=n[0],l=n[1],c=n[2],d=0,p=[];d<s.length;d++)r=s[d],o[r]&&p.push(o[r][0]),o[r]=0;for(i in l)Object.prototype.hasOwnProperty.call(l,i)&&(t[i]=l[i]);u&&u(n);while(p.length)p.shift()();return a.push.apply(a,c||[]),e()}function e(){for(var t,n=0;n<a.length;n++){for(var e=a[n],i=!0,s=1;s<e.length;s++){var l=e[s];0!==o[l]&&(i=!1)}i&&(a.splice(n--,1),t=r(r.s=e[0]))}return t}var i={},o={app:0},a=[];function r(n){if(i[n])return i[n].exports;var e=i[n]={i:n,l:!1,exports:{}};return t[n].call(e.exports,e,e.exports,r),e.l=!0,e.exports}r.m=t,r.c=i,r.d=function(t,n,e){r.o(t,n)||Object.defineProperty(t,n,{enumerable:!0,get:e})},r.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,n){if(1&n&&(t=r(t)),8&n)return t;if(4&n&&"object"===typeof t&&t&&t.__esModule)return t;var e=Object.create(null);if(r.r(e),Object.defineProperty(e,"default",{enumerable:!0,value:t}),2&n&&"string"!=typeof t)for(var i in t)r.d(e,i,function(n){return t[n]}.bind(null,i));return e},r.n=function(t){var n=t&&t.__esModule?function(){return t["default"]}:function(){return t};return r.d(n,"a",n),n},r.o=function(t,n){return Object.prototype.hasOwnProperty.call(t,n)},r.p="/map-editor/";var s=window["webpackJsonp"]=window["webpackJsonp"]||[],l=s.push.bind(s);s.push=n,s=s.slice();for(var c=0;c<s.length;c++)n(s[c]);var u=l;a.push([0,"chunk-vendors"]),e()})({0:function(t,n,e){t.exports=e("56d7")},"034f":function(t,n,e){"use strict";var i=e("ec8c"),o=e.n(i);o.a},"56d7":function(t,n,e){"use strict";e.r(n);e("3a0f"),e("a3a3"),e("4d0b");var i=e("329b"),o=function(){var t=this,n=t.$createElement,e=t._self._c||n;return e("div",{staticClass:"flex-row",staticStyle:{overflow:"auto"},attrs:{id:"app"}},[e("div",{staticClass:"pr area-wrap oh"},[e("div",{staticClass:"layer"},[e("div",{staticClass:"typeMarks"},t._l(t.buildingTypes,function(n,i){return e("div",{key:"color"+i,staticClass:"_mark",style:{color:n.fill}},[t._v(t._s(n.title))])}))]),e("div",{staticClass:"layer",attrs:{id:"svgElements"}},[e("svg",{attrs:{width:"1000",height:"1000",xmlns:"http://www.w3.org/2000/svg"},on:{click:function(n){return n.target!==n.currentTarget?null:t.resetSvg(n)}}},[t._l(t.polygons,function(n,i){return[e("polygon",{key:"polygon"+i,class:{isBlock:n.block,svgArea:!0},style:n.type,attrs:{points:n.points,"data-x":n.attrDataX,"data-y":n.attrDataY,title:n.attrTitle},on:{click:function(e){t.clickElement(e,n)}}})]})],2)]),e("div",{staticClass:"layer mapFloat"},[t._l(t.polygons,function(n,i){return n.block?t._e():[e("span",{key:"float"+i,staticClass:"_title",style:{left:n.attrDataX+"px",top:n.attrDataY+"px"}},[t._v(t._s(n.attrTitle))])]})],2),"路径绘制"===t.mode||t.cachePointMode?e("div",{staticClass:"layer svgPath"},[e("div",{staticClass:"layer drawPath",on:{click:t.drawPath}},[t._l(t.currentPath,function(n,i){return t.cachePointMode?t._e():e("div",{key:"drawpoint"+i,staticClass:"drawPoint",class:{active:n.active},style:{left:n.x+"px",top:n.y+"px"},attrs:{title:n.x+","+n.y},on:{click:function(e){e.stopPropagation(),t.clickPoint(n)},mousedown:function(e){t.startPoint(e,n)}}})}),t._l(t.roads,function(n,i){return e("div",{key:"showPath"+i},t._l(n,function(n,o){return e("div",{key:"showPathPoint"+o,staticClass:"drawPoint",style:{left:n.x+"px",top:n.y+"px"},attrs:{title:"路径"+(i+1)+" "+n.x+","+n.y},on:{click:function(e){e.stopPropagation(),t.clickPoint(n)},mousedown:function(e){t.startPoint(e,n)}}})}))})],2),e("svg",{attrs:{width:"1000",height:"1000",xmlns:"http://www.w3.org/2000/svg"}},[t.cachePointMode?t._e():e("polyline",{staticClass:"editingPath",attrs:{points:t.currentPath.map(function(t){return t.x+","+t.y}).join(" ")}}),t._l(t.roads,function(n,i){return e("polyline",{key:"showPath"+i,class:{editingPath:!0,active:i===t.currentEditingPathIndex},attrs:{points:n.map(function(t){return t.x+","+t.y}).join(" ")}})})],2)]):t._e()]),e("div",{staticClass:"flex-1",staticStyle:{margin:"20px"}},[e("div",{staticClass:"flex-row"},[e("div",{staticClass:"flex-1"},[e("el-upload",{staticClass:"myUpload",attrs:{drag:"",action:"",accept:"image/svg+xml","before-upload":t.getFile}},[e("i",{staticClass:"el-icon-upload"}),e("div",{staticClass:"el-upload__text"},[t._v("导入地图svg文件")])])],1),e("div",{staticClass:"flex-1"},[e("el-upload",{staticClass:"myUpload",attrs:{drag:"",action:"",accept:"application/json","before-upload":t.importMap}},[e("i",{staticClass:"el-icon-upload"}),e("div",{staticClass:"el-upload__text"},[t._v("导入地图json文件")])])],1),e("div",{staticClass:"flex-1"},[e("el-upload",{staticClass:"myUpload",attrs:{drag:"",action:"",accept:"application/json","before-upload":t.importPath}},[e("i",{staticClass:"el-icon-upload"}),e("div",{staticClass:"el-upload__text"},[t._v("导入路径json文件")])])],1)]),e("div",{staticClass:"flex-row"},[e("el-radio-group",{attrs:{size:"small"},model:{value:t.mode,callback:function(n){t.mode=n},expression:"mode"}},[e("el-radio-button",{attrs:{label:"编辑地图"}}),e("el-radio-button",{attrs:{label:"路径绘制"}})],1),e("div",{staticClass:"flex-1",staticStyle:{"text-align":"right"}},[e("a",{attrs:{id:"mapDataDownload",download:"map.json",target:"_blank"}},[e("el-button",{attrs:{icon:"el-icon-download",size:"small"}},[t._v("保存地图数据")])],1),e("a",{attrs:{id:"pathDataDownload",download:"path.json",target:"_blank"}},[e("el-button",{attrs:{icon:"el-icon-download",size:"small",disabled:!t.roads.length}},[t._v("保存路线数据")])],1),e("el-button",{attrs:{type:"danger",icon:"el-icon-warning",size:"small",disabled:!t.polygonsBackup},on:{click:t.resetData}},[t._v("重做")])],1)],1),e("el-form",{directives:[{name:"show",rawName:"v-show",value:"编辑地图"===t.mode,expression:"mode==='编辑地图'"}],staticStyle:{margin:"40px 0 0"},attrs:{"label-width":"100px"}},[t.currentPolygon.points?[e("el-form-item",{attrs:{label:"标题"}},[e("el-input",{attrs:{id:"infoInputer"},model:{value:t.currentPolygon.attrTitle,callback:function(n){t.$set(t.currentPolygon,"attrTitle",n)},expression:"currentPolygon.attrTitle"}})],1),e("el-form-item",{attrs:{label:"描述"}},[e("el-input",{attrs:{type:"textarea"},model:{value:t.currentPolygon.desc,callback:function(n){t.$set(t.currentPolygon,"desc",n)},expression:"currentPolygon.desc"}})],1),e("el-form-item",{attrs:{label:"所属类型"}},[e("el-select",{attrs:{"value-key":"title",placeholder:"请选择"},model:{value:t.currentPolygon.type,callback:function(n){t.$set(t.currentPolygon,"type",n)},expression:"currentPolygon.type"}},t._l(t.buildingTypes,function(t){return e("el-option",{key:t.title,attrs:{label:t.title,value:t}})}))],1),e("el-form-item",{attrs:{label:"关联路径节点"}},[e("el-button",{attrs:{disabled:t.currentPolygon.block,icon:"el-icon-location",circle:""},on:{click:function(n){t.cachePointMode=!0}}}),e("el-button",{directives:[{name:"show",rawName:"v-show",value:t.cachePointMode,expression:"cachePointMode"}],on:{click:function(n){t.cachePointMode=!1}}},[t._v("退出拾取")]),e("el-button",{directives:[{name:"show",rawName:"v-show",value:t.currentPolygon.connectPoint&&t.currentPolygon.connectPoint.x,expression:"currentPolygon.connectPoint && currentPolygon.connectPoint.x"}],on:{click:function(n){t.breakConnect()}}},[t._v("清除关联")]),t.currentPolygon.connectPoint&&t.currentPolygon.connectPoint.x?e("div",[t._v("\n            "+t._s(JSON.stringify(t.currentPolygon.connectPoint))+"\n          ")]):t._e()],1),e("el-form-item",{attrs:{label:"忽略建筑物"}},[e("el-switch",{model:{value:t.currentPolygon.block,callback:function(n){t.$set(t.currentPolygon,"block",n)},expression:"currentPolygon.block"}})],1)]:[e("div",[t._v("从左侧地图中选择区域，单击进入编辑")])]],2),e("div",{directives:[{name:"show",rawName:"v-show",value:"路径绘制"===t.mode&&!t.cachePointMode,expression:"mode==='路径绘制' && !cachePointMode"}]},[e("div",{staticClass:"m pathList"},t._l(t.roads,function(n,i){return e("el-tag",{key:"road"+i,staticClass:"_pathtag",attrs:{type:i===t.currentEditingPathIndex?"success":"info"},nativeOn:{click:function(n){t.choosePath(i)}}},[t._v("路径"+t._s(i+1))])})),e("el-table",{ref:"currentRoadsPointsTable",staticStyle:{width:"100%"},attrs:{"empty-text":"在左侧地图上开始绘制",data:t.currentPath,"highlight-current-row":!0},on:{"current-change":t.triggerCurrentFromTable}},[e("el-table-column",{attrs:{type:"index",width:"50"}}),e("el-table-column",{attrs:{label:"坐标",width:"150"},scopedSlots:t._u([{key:"default",fn:function(n){return[t._v("\n          X: "+t._s(n.row.x)+" Y: "+t._s(n.row.y)+"\n        ")]}}])}),e("el-table-column",{attrs:{label:"关联建筑"},scopedSlots:t._u([{key:"default",fn:function(n){return[n.row.connectBuildings?e("div",[t._v("\n            "+t._s(n.row.connectBuildings.join("、"))+"\n          ")]):t._e()]}}])}),e("el-table-column",{attrs:{label:"操作",width:"280",align:"center"},scopedSlots:t._u([{key:"default",fn:function(n){return[e("el-button",{attrs:{size:"mini",type:"primary"},on:{click:function(e){t.insertPoint(n.$index,-1)}}},[t._v("前添加")]),e("el-button",{attrs:{size:"mini",type:"primary"},on:{click:function(e){t.insertPoint(n.$index,1)}}},[t._v("后添加")]),e("el-button",{attrs:{size:"mini",type:"danger"},on:{click:function(e){t.deleteCurrentPathPoint(n.$index)}}},[t._v("删除")])]}}])})],1),e("div",{staticClass:"tc m"},[e("el-button",{attrs:{type:"primary",size:"small",disabled:!t.currentPath||!t.currentPath.length},on:{click:t.addPath}},[t._v("保存路径")]),e("el-button",{attrs:{size:"small",disabled:!t.currentPath||!t.currentPath.length},on:{click:t.clearPath}},[t._v("清除节点")]),e("el-button",{attrs:{type:"danger",size:"small",disabled:!t.currentEditingPathIndex},on:{click:function(n){t.deletePath(t.currentEditingPathIndex)}}},[t._v("删除路径")])],1)],1)],1)])},a=[],r=(e("25d7"),e("aba3"),e("2b1f"),e("bc72"),e("504b")),s=function(t,n){var e=new FileReader;e.readAsText(t),e.onload=function(){"function"===typeof n&&n(this.result)}},l=function t(n){if(!n)return n;var e=n instanceof Array?[]:{};for(var i in n)e[i]="object"===Object(r["a"])(n[i])?t(n[i]):n[i];return e},c=function(t,n){if(void 0===n){var e=sessionStorage.getItem(t);return e&&0===e.indexOf("autostringify-")?JSON.parse(e.split("autostringify-")[1]):e}return("object"===Object(r["a"])(n)||Array.isArray(n))&&(n="autostringify-"+JSON.stringify(n)),sessionStorage.setItem(t,n)},u=function(t,n){var e=[],i=/<polygon([^<]+)\/>/g,o=t.match(i);if(!o.length)return console.warn("svg文件异常");o.forEach(function(t){var n=/points="([^"]+)"/g,i=/title="([^"]+)"/g,o=/data-x="([^"]+)"/g,a=/data-y="([^"]+)"/g,r=n.exec(t),s=i.exec(t),l=o.exec(t),c=a.exec(t);if(null===r)return console.warn('polygon without prop "points"');r=r[1].trim().split(" ").map(function(t){return t.trim().replace(/\\r\\n\\t/g,"")}).join(" ");var u=r.trim().split(" ").map(function(t){return t.trim().split(",").join(" ")});if(s=null===s?"未命名":s[1],null===l||null===c){var d,p,h,f,y=[],g=[];u.forEach(function(t){var n=t.split(" ");y.push(n[0]),g.push(n[1])}),d=Math.max.apply(null,y),p=Math.max.apply(null,g),h=Math.min.apply(null,y),f=Math.min.apply(null,g),u=u.map(function(t){return t=t.split(" ").map(function(t){return t+"px"}),t.join(" ")}),l=parseInt((d+h)/2),c=parseInt((p+f)/2)}else l=l[1],c=c[1];e.push({points:r,attrDataX:l,attrDataY:c,attrTitle:s,connectPoint:{}})}),"function"===typeof n&&n(e)},d=function(t,n){for(var e=null,i=0;i<n.length;i++){var o=n[i];if(o.x===t.x&&o.y===t.y){e=i;break}}return e},p=[{title:"餐饮",fill:"#f2dc66",stroke:"#cebd63"},{title:"服装",fill:"#fece8b",stroke:"#e0b170"},{title:"百货",fill:"#eacf98",stroke:"#d9b87a"},{title:"娱乐",fill:"#87A765",stroke:"#7eb543"},{title:"美容美发",fill:"#e89bb6",stroke:"#ce7795"},{title:"电子数码",fill:"#94cefd",stroke:"#8abbe3"}],h={},f=function(t){var n=h.point;if(n){var e=t.clientX-h.x,i=t.clientY-h.y;0===e&&0===i||(n.isMoving=!0,n.x+=e,n.y+=i,h.x=t.clientX,h.y=t.clientY)}},y=function t(){document.removeEventListener("mousemove",f),document.removeEventListener("mouseup",t)},g={name:"app",data:function(){return{mainDom:null,mapDataDownloadDom:null,pathDataDownloadDom:null,polygonsBackup:null,polygons:[],roads:[],currentPolygon:{},mode:"编辑地图",cachePointMode:!1,currentPath:[],currentEditingPathIndex:null,buildingTypes:p}},watch:{mode:function(){this.resetSvg()},polygons:{handler:function(t){var n=this;if(c("editing-polygons",t),this.mapDataDownloadDom){var e=this.polygons.map(function(t,e){return 0===e?"["+JSON.stringify(t)+",":e===n.polygons.length-1?JSON.stringify(t)+"]":JSON.stringify(t)+","}),i=new Blob(e,{type:"application/json"});this.mapDataDownloadDom.href=window.URL.createObjectURL(i)}},deep:!0}},methods:{triggerCurrentFromTable:function(t,n){var e=this;t&&(t.active=!0),n&&delete n.active,this.$nextTick(function(){e.$forceUpdate()})},insertPoint:function(t,n){var e,i,o,a=this.currentPath[t];if(n<0){if(t>0)e=this.currentPath[t-1];else{var r=this.currentPath[t+1],s={x:a.x-r.x,y:a.y-r.y};e={x:a.x+s.x,y:a.y+s.y}}o=t}else{if(t===this.currentPath.length-1){var l=this.currentPath[t-1],c={x:a.x-l.x,y:a.y-l.y};e={x:a.x+c.x,y:a.y+c.y}}else e=this.currentPath[t+1];o=t+1}i={x:parseInt((a.x+e.x)/2),y:parseInt((a.y+e.y)/2)},this.currentPath.splice(o,0,i)},startPoint:function(t,n){h={x:t.clientX,y:t.clientY,point:n,pointCache:l(n)},document.addEventListener("mousemove",f),document.addEventListener("mouseup",y)},clickPoint:function(t){if(t.isMoving){var n=h.point,e=h.pointCache;e&&e.connect&&this.roads.forEach(function(t){t.forEach(function(t){t.connect&&t.x===e.x&&t.y===e.y&&(t.x=n.x,t.y=n.y)})}),h={},delete t.isMoving}else if(this.cachePointMode){this.currentPolygon.connectPoint=t,t.connectBuildings||(t.connectBuildings=[]);var i=t.connectBuildings.indexOf(this.currentPolygon.attrTitle);i<0&&t.connectBuildings.push(this.currentPolygon.attrTitle),this.cachePointMode=!1,this.savePath()}else{var o=d(t,this.currentPath);t.active?this.$refs.currentRoadsPointsTable.setCurrentRow():null!==o?this.$refs.currentRoadsPointsTable.setCurrentRow(t):(this.currentPath.push(t),t.connect=!0)}},breakConnect:function(){var t=this.currentPolygon.connectPoint.connectBuildings.indexOf(this.currentPolygon.attrTitle);t>=0&&this.currentPolygon.connectPoint.connectBuildings.splice(t,1),delete this.currentPolygon.connectPoint},drawPath:function(t){h&&h.point?h={}:this.currentPath.push({x:t.offsetX,y:t.offsetY})},deleteCurrentPathPoint:function(t){this.currentPath.splice(t,1)},deletePath:function(t){var n=this;this.$confirm("删除路径"+(t+1)+"?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(function(){n.roads.splice(t,1),n.currentPath=[],n.savePath()})},choosePath:function(t){if(this.currentEditingPathIndex===t)return this.currentPath=[],this.currentEditingPathIndex=null,null;this.currentEditingPathIndex=t,this.currentPath=this.roads[t]},clearPath:function(){this.currentPath=[],null!==this.currentEditingPathIndex&&this.deletePath(this.currentEditingPathIndex)},addPath:function(){this.currentEditingPathIndex?this.roads.splice(this.currentEditingPathIndex,1,l(this.currentPath)):this.roads.push(l(this.currentPath)),this.currentPath=[],this.currentEditingPathIndex=null,this.savePath()},savePath:function(){var t=this;if(c("editing-roads",this.roads),this.pathDataDownloadDom){var n=this.roads.map(function(n,e){return 0===e?"["+JSON.stringify(n)+",":e===t.roads.length-1?JSON.stringify(n)+"]":JSON.stringify(n)+","}),e=new Blob(n,{type:"application/json"});this.pathDataDownloadDom.href=window.URL.createObjectURL(e)}},resetData:function(){this.resetSvg(),Array.isArray(this.polygonsBackup)&&(this.polygons=l(this.polygonsBackup))},resetSvg:function(){if(this.currentPolygon={},this.mainDom){var t=this.mainDom.querySelectorAll("polygon.active");t.forEach(function(t){t.classList.remove("active")})}},clickElement:function(t,n){this.resetSvg(),t.target.classList.add("active"),this.currentPolygon=n,this.$nextTick(function(){document.getElementById("infoInputer").focus()})},reset:function(){this.currentPolygon={},this.currentPath=[],this.mode="编辑地图"},getFile:function(t){var n=this;return n.reset(),s(t,function(t){u(t,function(t){n.polygonsBackup=t,n.polygons=l(t)})}),!1},importMap:function(t){var n=this,e=this;return e.reset(),s(t,function(t){var e=JSON.parse(t);e.forEach(function(t){t.connectPoint||(t.connectPoint={})}),n.polygons=e,c("editing-polygons",e)}),!1},importPath:function(t){var n=this,e=this;return e.reset(),s(t,function(t){n.roads=JSON.parse(t),c("editing-roads",n.roads)}),!1}},created:function(){var t=c("editing-polygons");t&&(this.polygons=t);var n=c("editing-roads");n&&(this.roads=n)},mounted:function(){this.mainDom=document.getElementById("svgElements"),this.mapDataDownloadDom=document.getElementById("mapDataDownload"),this.pathDataDownloadDom=document.getElementById("pathDataDownload")}},v=g,m=(e("034f"),e("048f")),P=Object(m["a"])(v,o,a,!1,null,null,null);P.options.__file="App.vue";var x=P.exports,b=e("beff"),w=e.n(b);e("f513");i["default"].use(w.a),i["default"].config.productionTip=!1,new i["default"]({render:function(t){return t(x)}}).$mount("#app")},ec8c:function(t,n,e){}});
//# sourceMappingURL=app.ba17c8c7.js.map